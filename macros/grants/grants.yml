version: 2

# NOTE (refactor summary - do not alter macro interfaces):
# Ownership and grant macros have been refactored for consistency:
# - Top-level action macros now log summaries instead of returning data
# - Ownership helper macros implement early exits (flags.WHICH + execute) and structured logging
# - Statement construction is standardized; duplicate privilege accumulation removed
# - Argument signatures remain unchanged; only documentation clarified below where list types were previously marked as string
# - Set var('grants_dry_run', true) in a dbt invocation to log all statements without executing them for newly refactored macros

macros:
  - name: grant_internal_share_read
    description: Grants SELECT on all tables and views in all schemas of the target database to the specified share. Executes grant statements for each table and view found.
    docs:
      show: true
    arguments:
      - name: share_name
        type: string
        description: Name of the share to grant SELECT privileges to
      - name: exclude_schemas
        type: List[string]
        description: List of schemas to exclude from granting

  - name: grant_database_ownership
    description: This macro grants ownership privileges to the specified rolename on the database.
    docs:
      show: true
    arguments:
      - name: role_name
        type: string
        description: Name of the role eg- DATAOPS_ADMIN


  - name: grant_integration_ownership
    description: This macro grants ownership privileges to the specified rolename on the integration.
    docs:
      show: true
    arguments:
      - name: integration_name
        type: string
        description: Name of the integration to grant ownership to
      - name: role_name
        type: string
        description: Name of the role eg- DATAOPS_ADMIN


  - name: grant_database_usage
    description: This macro grants usage privileges to the specified roles and/or shares inside the database.
    docs:
      show: true
    arguments:
      - name: grant_roles
        type: List[string]
        description: List of roles to apply eg- ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT']
      - name: grant_shares
        type: List[string]
        description: Name of the shares to apply database usage to
      - name: revoke_current_grants
        type: "boolean"
        description: Revoke current grants on the schemas

  - name: grant_integration_usage
    description: This macro grants usage privileges to the specified rolename on the integration.
    docs:
      show: true
    arguments:
      - name: integration_name
        type: string
        description: Name of the integration to grant usgae to
      - name: role_name
        type: string
        description: Name of the role eg- DEVELOPERS


  - name: grant_object
    description: |
      Grants specified privileges on objects (TABLE, VIEW, SCHEMA, etc.) to the provided roles.
      Handles both granting and revoking privileges based on current state, logging a summary of actions taken.
    docs:
      show: true
    arguments:
      - name: object_type
        type: string
        description: Type of the object (e.g., TABLE, VIEW, SCHEMA)
      - name: objects
        type: List[string]
        description: List of objects to apply the permission to (format = schema.object)
      - name: grant_types
        type: List[string]
        description: List of privilege types to grant (e.g., SELECT, REFERENCES)
      - name: grant_roles
        type: List[string]
        description: List of roles to grant privileges to

  - name: grant_usage_to_application
    description: This macro grants usage privileges on specific objects to a specific application role.
    docs:
      show: true
    arguments:
      - name: object_type
        type: string
        description: Type of the object eg- TABLE, VIEW, SCHEMA
      - name: prefix
        type: string
        description: Prefix for the objects to apply the permission to (format = schema.object)
      - name: grant_applications
        type: List[string]
        description: List of application roles to grant usage privileges to

  - name: grant_database_usage_to_application
    description: This macro grants usage privileges on a database to a specific application role.
    docs:
      show: false
    arguments:
      - name: grant_applications
        type: List[string]
        description: List of application roles to grant usage privileges to
      - name: target_database
        type: string
        description: target database

  - name: grant_schema_usage_to_application
    description: This macro grants usage privileges on a schema to a specific application role.
    docs:
      show: false
    arguments:
      - name: grant_applications
        type: List[string]
        description: List of application roles to grant usage privileges to
      - name: target_database
        type: string
        description: target database
      - name: schemas
        type: List[string]
        description: List of schemas to grant usage privileges on

  - name: grant_privileges
    description: |
      Grants a bundle of privileges across environments based on target context.
      Calls multiple grant macros for database, schema, and role management, orchestrating environment-specific grants.
    docs:
      show: true
    arguments:
      - name: domain_schemas
        type: List[string]
        description: List of schemas which are domain specific that should be exposed

  - name: grant_schema_monitor
    description: |
      Grants MONITOR privilege on all objects in all schemas to the specified roles, excluding any schemas listed.
      Uses grant_schema_monitor_specific for per-schema operations and supports dry-run mode.
    docs:
      show: true
    arguments:
      - name: exclude_schemas
        type: List[string]
        description: List of schemas to exclude
      - name: grant_roles
        type: List[string]
        description: List of roles to apply (e.g., ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT'])

  - name: grant_schema_monitor_specific
    description: This macro grants monitor privilege inside specific schemas to the specified rolename.
    docs:
      show: true
    arguments:
      - name: schemas
        type: List[string]
        description: List of schemas to include
      - name: grant_roles
        type: "List[string]"
        description: Name of the roles to apply eg- ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT']
      - name: revoke_current_grants
        type: "boolean"
        description: Revoke current grants on the schemas


  - name: grant_schema_operate
    description: This macro grants operator privilege inside all schemas to the specified rolename.
    docs:
      show: true
    arguments:
      - name: exclude_schemas
        type: List[string]
        description: List of schemas to exclude
      - name: grant_roles
        type: "List[string]"
        description: Name of the roles to apply eg- ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT']

  - name: grant_schema_operate_specific
    description: This macro grants operator privilege inside specific schemas to the specified rolename.
    docs:
      show: true
    arguments:
      - name: schemas
        type: List[string]
        description: List of schemas to include
      - name: grant_roles
        type: "List[string]"
        description: Name of the roles to apply eg- ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT']
      - name: revoke_current_grants
        type: "boolean"
        description: Revoke current grants on the schemas


  - name: grant_schema_ownership
    description: This macro grants ownership privilege inside all schemas to the specified role_name.
    docs:
      show: true
    arguments:
      - name: exclude_schemas
        type: List[string]
        description: List of schemas to exclude
      - name: role_name
        type: string
        description: Name of the role eg- ANALYST


  - name: grant_schema_read
    description: This macro grants usage and select privilege inside all schemas to the specified grant_roles.
    docs:
      show: true
    arguments:
      - name: exclude_schemas
        type: List[string]
        description: List of schemas to exclude
      - name: grant_roles
        type: List[string]
        description: List of roles to apply eg- ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT']
      - name: include_future_grants
        type: "boolean"
        description: Specifies if to include future grants or not

  - name: grant_schema_read_specific
    description: This macro grants usage and select privilege inside the schema to the specified rolenames.
    docs:
      show: true
    arguments:
      - name: schemas
        type: List[string]
        description: List of schemas to include
      - name: grant_roles
        type: List[string]
        description: List of roles to apply eg- ['READERS_PROD', 'ANALYST', 'OPS_SUPPORT']
      - name: include_future_grants
        type: "boolean"
        description: Specifies if to include future grants or not
      - name: revoke_current_grants
        type: "boolean"
        description: Specifies if to revoke current grants or not

  - name: grant_share_read
    description: |
      Grants SELECT on specified views to the provided shares, and optionally revokes unmanaged grants.
      Handles both granting and revoking privileges for views in schemas, based on the view_names and grant_shares arguments.
      Uses grant_share_read_specific_schema for per-schema operations.
    docs:
      show: true
    arguments:
      - name: view_names
        type: List[string]
        description: List of secured views to include [schema.view]
      - name: grant_shares
        type: List[string]
        description: List of shares to apply
      - name: revoke_current_grants
        type: boolean
        description: Whether to revoke unmanaged grants before applying new ones

  - name: grant_share_read_specific_schema
    description: This macro grants select permissions to the specified view for the shares provided.
    docs:
      show: true
    arguments:
      - name: schema_name
        type: string
        description: Name of the schema to include
      - name: view_names
        type: List[string]
        description: List of views to include
      - name: grant_shares
        type: string
        description: Name of the shares to apply
      - name: revoke_current_grants
        type: "boolean"
        description: Specifies if to revoke current grants or not

  - name: grants_smoke_test
    description: Lightweight validation macro that exercises a subset of grant macros (monitor, operate, read, share) â€“ intended for CI dry-run verification.
    docs:
      show: true
    arguments:
      - name: role
        type: string
        description: Role to test with
      - name: sample_schema
        type: string
        description: Schema to scope sample grant operations to

  - name: grant_schema_procedure_usage
    description: Grant USAGE privilege on all procedures in all schemas to specified roles.
    docs:
      show: true
    arguments:
      - name: exclude_schemas
        type: List[string]
        description: List of schemas to exclude from procedure grants
      - name: grant_roles
        type: List[string]
        description: List of roles to grant procedure usage to

  - name: grant_schema_procedure_usage_specific
    description: Grant USAGE privilege on all procedures in specific schemas to specified roles.
    docs:
      show: true
    arguments:
      - name: schemas
        type: List[string]
        description: List of schemas to include for procedure grants
      - name: grant_roles
        type: List[string]
        description: List of roles to grant procedure usage to
      - name: revoke_current_grants
        type: boolean
        description: Whether to revoke existing grants from roles not in grant_roles
      - name: dry_run
        type: boolean
        description: Whether to run in dry-run mode (log statements without executing)
